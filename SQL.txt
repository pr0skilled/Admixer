3.1
select concat(t.NTOV, ' ', t.SORT) as 'Назва товару',
       Sum(s.KOL) as 'Кількість',
       Sum(s.CENA * s.KOL) as 'Сума'
from DMS s
inner join DMZ z on S.NDM = Z.NDM
inner join TOV t on S.KTOV = T.KTOV
where z.DDM = '2022-05-01'
  and z.PR = 2
group by concat(t.NTOV, ' ', t.SORT)
order by 'Сума' desc

3.2
update DMS
set
sort =
  (select
   sort
   from TOV
   where TOV.KTov = DMS.KTov)

3.3
select --ST.KTOV,
       ST.TOV,
       --KL_Prixod,
       --Sum_Prixod,
       --KL_Rasxod,
       --Sum_Rasxod,
       KL_Prixod - KL_Rasxod as 'Залишок (кількість)',
       Sum_Prixod-Sum_Rasxod as 'Залишок (сума)'
from (
        (select T.KTOV,
                T.NTOV + ' ' + T.Sort TOV
         from TOV T) ST
      left join
        (select T.KTOV,
                Sum(S.KOL) as 'KL_Prixod',
                Sum(S.KOL*S.CENA) as 'Sum_Prixod'
         from dbo.DMS S
         inner join dbo.DMZ Z on S.NDM = Z.NDM
         inner join dbo.TOV T on S.KTOV = T.KTOV
         where Z.PR = 1
         group by T.KTOV) PRIX on ST.KTOV = PRIX.KTOV
      left join
        (select T.KTOV,
                Sum(S.KOL) as 'KL_Rasxod',
                Sum(S.KOL*S.CENA) as 'Sum_Rasxod'
         from dbo.DMS S
         inner join dbo.DMZ Z on S.NDM = Z.NDM
         inner join dbo.TOV T on S.KTOV = T.KTOV
         where Z.PR = 2
         group by T.KTOV) RASX on ST.KTOV = RASX.KTOV)
order by 2

3.4
insert into DMZ(DDM, NDM, PR)
select GetDate(),
       Isnull(Max(NDM)+1, 1),
       case
           when
               (select Count(*) from DMZ where PR=1) > (select Count(*) from DMZ where PR=2)
           then 2
           else 1
       end
from DMZ

3.5
insert into dms (ktov, kol, cena,
                 sort, ndm)
  (select distinct ktov,
                   1 kol,
                   1.00 cena,
		           sort,
     (select max(ndm)
      from dmz) ndm
   from dms
   where ndm in
       (select min(ndm)
        from dmz)
     and ktov Not In
       (select ktov
        from dms
        where ndm in
            (select max(ndm)
             from dmz)))